-- Patch for uploaded_file lifecycle fields (MinIO-only flow)
-- Run on MySQL 8+ (idempotent thanks to IF NOT EXISTS)

ALTER TABLE uploaded_file
    ADD COLUMN IF NOT EXISTS status      VARCHAR(50)  NULL COMMENT 'Lifecycle: PENDING/READY/ATTACHED/DELETED',
    ADD COLUMN IF NOT EXISTS purpose     VARCHAR(50)  NULL COMMENT 'Purpose: THUMBNAIL/INTRO_VIDEO/LESSON_VIDEO/DOCUMENT/GENERIC',
    ADD COLUMN IF NOT EXISTS course_id   BIGINT       NULL COMMENT 'Context course for file',
    ADD COLUMN IF NOT EXISTS lesson_id   BIGINT       NULL COMMENT 'Context lesson for file';

-- Optional: add lookup indexes for context
ALTER TABLE uploaded_file
    ADD INDEX IF NOT EXISTS idx_uploaded_file_course (course_id),
    ADD INDEX IF NOT EXISTS idx_uploaded_file_lesson (lesson_id);

-- Phase 6: enrollment table already exists in schema (see db_prj3.txt). No DDL change required here.

-- Phase 11: add course price (run once; remove IF NOT EXISTS for compatibility)
ALTER TABLE course
    ADD COLUMN IF NOT EXISTS price_cents BIGINT NOT NULL DEFAULT 0 COMMENT 'Course price in cents';

-- Backfill existing rows so lifecycle checks work
UPDATE uploaded_file
SET
    status  = COALESCE(status, 'READY'),
    purpose = COALESCE(purpose, 'GENERIC')
WHERE status IS NULL OR purpose IS NULL;

ALTER TABLE payment_transaction
    ADD COLUMN  txn_ref VARCHAR(255) COMMENT 'VNPay TxnRef (unique per pay request)',
    ADD COLUMN  payment_url TEXT COMMENT 'Generated payment URL',
    ADD COLUMN  expired_at DATETIME COMMENT 'Payment link expiration time';

-- Q&A: use is_accepted for moderation (true=approved, false/null=pending)
-- If you previously added answer.status, drop it with:
-- ALTER TABLE answer DROP COLUMN status;

-- Cart (multi-course checkout)
CREATE TABLE IF NOT EXISTS cart
(
    id                   BIGINT AUTO_INCREMENT PRIMARY KEY,

    user_id              BIGINT NOT NULL COMMENT 'FK -> user (cart owner)',
    status               VARCHAR(50) NULL COMMENT 'Status: ACTIVE/CHECKED_OUT',

    is_active            TINYINT(1)    NULL,
    is_deleted           TINYINT(1)    NULL,
    created_date         DATETIME      NULL,
    updated_date         DATETIME      NULL,
    created_user         VARCHAR(255)  NULL,
    updated_user         VARCHAR(255)  NULL,

    KEY idx_cart_user (user_id),
    CONSTRAINT fk_cart_user FOREIGN KEY (user_id) REFERENCES `user` (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS cart_item
(
    id                   BIGINT AUTO_INCREMENT PRIMARY KEY,

    cart_id              BIGINT NOT NULL COMMENT 'FK -> cart',
    course_id            BIGINT NOT NULL COMMENT 'FK -> course',
    price_cents          BIGINT NOT NULL COMMENT 'Snapshot price in VND',
    final_price_cents    BIGINT NOT NULL COMMENT 'Final price in VND',

    is_active            TINYINT(1)    NULL,
    is_deleted           TINYINT(1)    NULL,
    created_date         DATETIME      NULL,
    updated_date         DATETIME      NULL,
    created_user         VARCHAR(255)  NULL,
    updated_user         VARCHAR(255)  NULL,

    UNIQUE KEY uk_cart_item (cart_id, course_id),
    KEY idx_cart_item_cart (cart_id),
    KEY idx_cart_item_course (course_id),
    CONSTRAINT fk_cart_item_cart FOREIGN KEY (cart_id) REFERENCES cart (id),
    CONSTRAINT fk_cart_item_course FOREIGN KEY (course_id) REFERENCES course (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
